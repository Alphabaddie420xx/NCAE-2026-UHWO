# Flush existing rules
iptables -F
iptables -X

# Default DROP policy
iptables -P INPUT DROP
iptables -P OUTPUT DROP
iptables -P FORWARD DROP

# Allow loopback
iptables -A INPUT  -i lo -j ACCEPT
iptables -A OUTPUT -o lo -j ACCEPT

# Allow ping (ICMP echo-request/echo-reply)
iptables -A INPUT  -p icmp --icmp-type echo-request -j ACCEPT
iptables -A OUTPUT -p icmp --icmp-type echo-reply  -j ACCEPT
iptables -A INPUT  -p icmp --icmp-type echo-reply   -j ACCEPT
iptables -A OUTPUT -p icmp --icmp-type echo-request -j ACCEPT

# Allow DNS from internal subnet
iptables -A INPUT  -s 192.168.0.0/16 -p udp --dport 53 -j ACCEPT
iptables -A INPUT  -s 192.168.0.0/16 -p tcp --dport 53 -j ACCEPT

# Allow DNS from MikroTik (NATed external queries)
iptables -A INPUT -s 192.168.101.1 -p udp --dport 53 -j ACCEPT
iptables -A INPUT -s 192.168.101.1 -p tcp --dport 53 -j ACCEPT

# Allow DNS replies going out
iptables -A OUTPUT -p udp --sport 53 -j ACCEPT
iptables -A OUTPUT -p tcp --sport 53 -j ACCEPT

# Allow established/related traffic so DNS works correctly
iptables -A INPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT
iptables -A OUTPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

iptables -A FORWARD -s 192.168.101.1 -p udp --dport 53 -j ACCEPT
iptables -A FORWARD -s 192.168.101.1 -p tcp --dport 53 -j ACCEPT
iptables -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT

# Allow DNS from external subnet
iptables -A INPUT  -s 172.18.0.0/16 -p udp --dport 53 -j ACCEPT
iptables -A INPUT  -s 172.18.0.0/16 -p tcp --dport 53 -j ACCEPT
